<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå 2026</title>

    <!-- 1. Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Sarabun', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <!-- 2. Fonts (Sarabun) -->
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- 3. React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
    
    <!-- 4. Prop Types -->
    <script src="https://unpkg.com/prop-types/prop-types.min.js"></script>

    <!-- 5. Recharts -->
    <script src="https://unpkg.com/recharts@2.10.3/umd/Recharts.js"></script>

    <!-- 6. Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- 7. Lucide Icons -->
    <script src="https://unpkg.com/lucide@0.292.0/dist/umd/lucide.min.js"></script>

    <!-- 8. Html2Canvas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        body { font-family: 'Sarabun', sans-serif; background-color: #f9fafb; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #9ca3af; }
        @media print { .no-print { display: none !important; } }
        .loading-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; display: flex; justify-content: center; align-items: center; z-index: 9999; }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- Firebase SDK Setup -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, onSnapshot, serverTimestamp, deleteDoc, doc, setDoc, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // -----------------------------------------------------------
        // ‚ö†Ô∏è ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡πÉ‡∏™‡πà Firebase Config ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà
        // -----------------------------------------------------------
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY_HERE",
            authDomain: "YOUR_PROJECT.firebaseapp.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT.appspot.com",
            messagingSenderId: "YOUR_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        try {
            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getFirestore(app);
            
            window.fb = {
                auth, db, signInAnonymously, onAuthStateChanged, signInWithCustomToken,
                collection, addDoc, query, onSnapshot, serverTimestamp, deleteDoc, doc, setDoc, orderBy
            };
            window.dispatchEvent(new Event('firebase-ready'));
            console.log("Firebase Initialized");
        } catch (e) {
            console.warn("Firebase Config Error: ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà Config ‡πÉ‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î (‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î ~55)");
        }
    </script>

    <!-- React App Script -->
    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;
        const { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer } = window.Recharts;

        // --- Icon Helper ---
        const createIcon = (iconName) => (props) => {
            const iconData = window.lucide.icons[iconName];
            if (!iconData) return <span style={{color:'red'}}>?</span>;
            return React.createElement('svg', {
                ...iconData.attrs,
                ...props,
                className: `lucide lucide-${iconName} ${props.className || ''}`,
                width: props.size || 24,
                height: props.size || 24,
            }, iconData.children ? iconData.children.map((child, index) => 
                React.createElement(child[0], { ...child[1], key: index })
            ) : null);
        };

        const Plus = createIcon('Plus');
        const Trash2 = createIcon('Trash2');
        const Save = createIcon('Save');
        const ShoppingCart = createIcon('ShoppingCart');
        const TrendingUp = createIcon('TrendingUp');
        const Package = createIcon('Package');
        const Home = createIcon('Home');
        const List = createIcon('List');
        const X = createIcon('X');
        const Printer = createIcon('Printer');
        const FileDown = createIcon('FileDown');
        const LayoutGrid = createIcon('LayoutGrid');
        const LogOut = createIcon('LogOut');
        const Store = createIcon('Store');
        const Calendar = createIcon('Calendar');
        const Palette = createIcon('Palette');
        const Box = createIcon('Box');
        const DollarSign = createIcon('DollarSign');
        const ImageIcon = createIcon('Image');
        const MessageSquare = createIcon('MessageSquare');
        const Layers = createIcon('Layers');
        const Eye = createIcon('Eye');
        const FileText = createIcon('FileText');
        const PieChart = createIcon('PieChart');
        const ChevronDown = createIcon('ChevronDown');
        const ChevronRight = createIcon('ChevronRight');
        const Grid = createIcon('Grid');
        const Edit2 = createIcon('Edit2');
        const Upload = createIcon('Upload');
        const Loader = createIcon('Loader');
        const Folder = createIcon('Folder');
        const LinkIcon = createIcon('Link');
        const ExternalLink = createIcon('ExternalLink');
        const FileSpreadsheet = createIcon('FileSpreadsheet');
        const File = createIcon('File');
        const AlertTriangle = createIcon('AlertTriangle'); // Added missing icon

        // --- Data Constants ---
        const BRANDS = ['‡∏ù‡∏≤‡∏ä‡∏°‡∏û‡∏π', '‡∏°‡∏≠‡∏™', '‡∏Å‡∏≠‡∏ä12', '‡πÄ‡∏•‡∏¥‡∏ü', '‡∏Å‡∏≠‡∏ä14', '‡∏Å‡∏≠‡∏ä‡∏™‡∏ï‡∏≤‡∏£‡πå', '‡∏¢‡∏≤‡∏•‡πâ‡∏≤‡∏á', '‡∏°‡∏∞‡∏Å‡∏≠‡∏Å', '‡∏ô‡πâ‡∏≥‡∏¢‡∏≤‡∏•‡πâ‡∏≤‡∏á‡πÄ‡∏•‡πá‡∏ö', '‡∏ü‡∏≠‡∏á‡∏ô‡πâ‡∏≥‡∏Ç‡∏±‡∏î‡πÄ‡∏ó‡πâ‡∏≤', '‡∏ä‡∏≠‡∏•‡πå‡∏Ñ‡∏™‡∏µ', '‡∏ä‡∏≠‡∏•‡πå‡∏Ñ‡∏Ç‡∏≤‡∏ß', '‡∏¢‡∏≤‡∏•‡πâ‡∏≤‡∏á‡∏õ‡∏≠‡∏ô‡∏î‡πå'];
        const BRAND_PRICES = { '‡∏ù‡∏≤‡∏ä‡∏°‡∏û‡∏π': 98, '‡∏°‡∏≠‡∏™': 113, '‡∏Å‡∏≠‡∏ä12': 120, '‡πÄ‡∏•‡∏¥‡∏ü': 115, '‡∏Å‡∏≠‡∏ä14': 120, '‡∏Å‡∏≠‡∏ä‡∏™‡∏ï‡∏≤‡∏£‡πå': 120, '‡∏ô‡πâ‡∏≥‡∏¢‡∏≤‡∏•‡πâ‡∏≤‡∏á‡πÄ‡∏•‡πá‡∏ö': 60, '‡∏°‡∏∞‡∏Å‡∏≠‡∏Å': 85, '‡∏ô‡πâ‡∏≥‡∏¢‡∏≤‡∏•‡πâ‡∏≤‡∏á‡∏õ‡∏≠‡∏ô‡∏î‡πå': 375, '‡∏ü‡∏≠‡∏á‡∏ô‡πâ‡∏≥‡∏Ç‡∏±‡∏î‡πÄ‡∏ó‡πâ‡∏≤': 140, '‡∏ä‡∏≠‡∏•‡πå‡∏Ñ‡∏™‡∏µ': 50, '‡∏ä‡∏≠‡∏•‡πå‡∏Ñ‡∏Ç‡∏≤‡∏ß': 40, '‡∏¢‡∏≤‡∏•‡πâ‡∏≤‡∏á': 55 };
        const BRAND_IMAGES = {
            '‡∏ù‡∏≤‡∏ä‡∏°‡∏û‡∏π': 'https://placehold.co/400x400/ff99cc/ffffff?text=‡∏ù‡∏≤‡∏ä‡∏°‡∏û‡∏π', '‡∏°‡∏≠‡∏™': 'https://placehold.co/400x400/99ff99/000000?text=‡∏°‡∏≠‡∏™', '‡∏Å‡∏≠‡∏ä12': 'https://placehold.co/400x400/ffcc99/000000?text=‡∏Å‡∏≠‡∏ä12',
            '‡πÄ‡∏•‡∏¥‡∏ü': 'https://placehold.co/400x400/ff6666/ffffff?text=‡πÄ‡∏•‡∏¥‡∏ü', '‡∏Å‡∏≠‡∏ä14': 'https://placehold.co/400x400/ffcc99/000000?text=‡∏Å‡∏≠‡∏ä14', '‡∏Å‡∏≠‡∏ä‡∏™‡∏ï‡∏≤‡∏£‡πå': 'https://placehold.co/400x400/ffff99/000000?text=‡∏Å‡∏≠‡∏ä‡∏™‡∏ï‡∏≤‡∏£‡πå',
            '‡∏¢‡∏≤‡∏•‡πâ‡∏≤‡∏á': 'https://placehold.co/400x400/ccffff/000000?text=‡∏¢‡∏≤‡∏•‡πâ‡∏≤‡∏á', '‡∏°‡∏∞‡∏Å‡∏≠‡∏Å': 'https://placehold.co/400x400/669900/ffffff?text=‡∏°‡∏∞‡∏Å‡∏≠‡∏Å', '‡∏ô‡πâ‡∏≥‡∏¢‡∏≤‡∏•‡πâ‡∏≤‡∏á‡πÄ‡∏•‡πá‡∏ö': 'https://placehold.co/400x400/33ccff/ffffff?text=‡∏ô‡πâ‡∏≥‡∏¢‡∏≤‡∏•‡πâ‡∏≤‡∏á‡πÄ‡∏•‡πá‡∏ö',
            '‡∏ü‡∏≠‡∏á‡∏ô‡πâ‡∏≥‡∏Ç‡∏±‡∏î‡πÄ‡∏ó‡πâ‡∏≤': 'https://placehold.co/400x400/ffcc00/000000?text=‡∏ü‡∏≠‡∏á‡∏ô‡πâ‡∏≥‡∏Ç‡∏±‡∏î‡πÄ‡∏ó‡πâ‡∏≤', '‡∏ä‡∏≠‡∏•‡πå‡∏Ñ‡∏™‡∏µ': 'https://placehold.co/400x400/ff99ff/ffffff?text=‡∏ä‡∏≠‡∏•‡πå‡∏Ñ‡∏™‡∏µ', '‡∏ä‡∏≠‡∏•‡πå‡∏Ñ‡∏Ç‡∏≤‡∏ß': 'https://placehold.co/400x400/eeeeee/000000?text=‡∏ä‡∏≠‡∏•‡πå‡∏Ñ‡∏Ç‡∏≤‡∏ß',
            '‡∏¢‡∏≤‡∏•‡πâ‡∏≤‡∏á‡∏õ‡∏≠‡∏ô‡∏î‡πå': 'https://placehold.co/400x400/0099cc/ffffff?text=‡∏¢‡∏≤‡∏•‡πâ‡∏≤‡∏á‡∏õ‡∏≠‡∏ô‡∏î‡πå'
        };
        const COLORS = ['F1', 'F2', 'F3', 'F4', 'F5', 'F6', 'F7', 'F8', 'F9', 'F10', 'F11', 'F12', '‡∏ä‡∏°‡∏û‡∏π', '‡∏ä‡∏°‡∏û‡∏π‡πÄ‡∏Ç‡πâ‡∏°', '‡∏Ñ‡∏•‡∏∞‡∏™‡∏î', '‡∏Ñ‡∏•‡∏∞‡πÅ‡∏ü‡∏ä‡∏±‡πà‡∏ô', '‡∏°‡∏∞‡∏î‡∏≥+‡∏°‡∏∞‡πÅ‡∏î‡∏á', '‡∏™‡∏µ‡∏≠‡πà‡∏≠‡∏ô', '‡∏ä‡∏∏‡∏î‡πÅ‡∏î‡∏á', '‡∏ä‡∏∏‡∏î‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß', '‡∏ä‡∏∏‡∏î‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô', '‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á', '‡∏Å‡∏∞‡∏õ‡∏¥', '‡∏Å‡∏≤‡∏Å‡πÄ‡∏û‡∏ä‡∏£', '‡∏Ç‡∏≤‡∏ß', '‡∏î‡∏≥', '‡∏Ç‡∏≤‡∏ß+‡∏î‡∏≥', '‡∏°‡∏∞‡πÅ‡∏î‡∏á', '‡∏°‡∏∞‡∏î‡∏≥', '‡∏Ñ‡∏•‡∏∞ 3', '‡∏Ñ‡∏•‡∏∞ 5', '‡∏Ñ‡∏•‡∏∞ 8', '‡∏Ñ‡∏•‡∏∞ 9', '‡∏ä‡∏≠‡∏•‡πå‡∏Ñ‡∏™‡∏µ', '‡∏ä‡∏≠‡∏•‡πå‡∏Ñ‡∏Ç‡∏≤‡∏ß'];
        const COLOR_VISUALS = { 'F1': '#FF69B4', 'F2': '#FF1493', 'F3': '#C71585', 'F4': '#DB7093', 'F5': '#FFB6C1', 'F6': '#F0F8FF', 'F7': 'linear-gradient(45deg, #e6e6e6 25%, #ffffff 25%)', 'F8': '#FFFFFF', 'F9': '#000000', 'F10': '#4B0082', 'F11': '#800000', 'F12': '#BC8F8F', '‡∏ä‡∏°‡∏û‡∏π': '#FFC0CB', '‡∏ä‡∏°‡∏û‡∏π‡πÄ‡∏Ç‡πâ‡∏°': '#FF69B4', '‡∏Ñ‡∏•‡∏∞‡∏™‡∏î': 'linear-gradient(to right, #ff0000, #00ff00, #0000ff)', '‡∏Ñ‡∏•‡∏∞‡πÅ‡∏ü‡∏ä‡∏±‡πà‡∏ô': 'linear-gradient(to right, #ff00ff, #ffff00, #00ffff)', '‡∏°‡∏∞‡∏î‡∏≥+‡∏°‡∏∞‡πÅ‡∏î‡∏á': 'linear-gradient(to right, #4B0082 50%, #800000 50%)', '‡∏™‡∏µ‡∏≠‡πà‡∏≠‡∏ô': '#F5F5DC', '‡∏ä‡∏∏‡∏î‡πÅ‡∏î‡∏á': '#DC143C', '‡∏ä‡∏∏‡∏î‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß': '#228B22', '‡∏ä‡∏∏‡∏î‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô': '#00008B', '‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á': '#FFD700', '‡∏Å‡∏∞‡∏õ‡∏¥': '#BC8F8F', '‡∏Å‡∏≤‡∏Å‡πÄ‡∏û‡∏ä‡∏£': 'radial-gradient(circle, #fff 10%, #ccc 90%)', '‡∏Ç‡∏≤‡∏ß': '#FFFFFF', '‡∏î‡∏≥': '#000000', '‡∏Ç‡∏≤‡∏ß+‡∏î‡∏≥': 'linear-gradient(to right, #ffffff 50%, #000000 50%)', '‡∏°‡∏∞‡πÅ‡∏î‡∏á': '#800000', '‡∏°‡∏∞‡∏î‡∏≥': '#4B0082', '‡∏ä‡∏≠‡∏•‡πå‡∏Ñ‡∏™‡∏µ': 'linear-gradient(45deg, #FFB3BA, #FFDFBA, #BAE1FF)', '‡∏ä‡∏≠‡∏•‡πå‡∏Ñ‡∏Ç‡∏≤‡∏ß': '#F8F8FF', '‡∏Ñ‡∏•‡∏∞ 3': '#e5e7eb', '‡∏Ñ‡∏•‡∏∞ 5': '#e5e7eb', '‡∏Ñ‡∏•‡∏∞ 8': '#e5e7eb', '‡∏Ñ‡∏•‡∏∞ 9': '#e5e7eb' };
        const UNITS = ['‡πÇ‡∏´‡∏•', '‡∏ä‡∏¥‡πâ‡∏ô'];
        const DOC_CATEGORIES = ['‡∏™‡∏•‡∏¥‡∏õ‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô', '‡πÉ‡∏ö‡∏™‡πà‡∏á‡∏Ç‡∏≠‡∏á', '‡πÉ‡∏ö‡∏ß‡∏≤‡∏á‡∏ö‡∏¥‡∏•', '‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏†‡∏≤‡∏©‡∏µ', '‡∏≠‡∏∑‡πà‡∏ô‡πÜ'];

        // --- Helper Function ---
        const resizeImage = (file) => {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        const MAX_SIZE = 500;
                        let width = img.width; let height = img.height;
                        if (width > height) { if (width > MAX_SIZE) { height *= MAX_SIZE / width; width = MAX_SIZE; } } else { if (height > MAX_SIZE) { width *= MAX_SIZE / height; height = MAX_SIZE; } }
                        canvas.width = width; canvas.height = height;
                        ctx.drawImage(img, 0, 0, width, height);
                        resolve(canvas.toDataURL('image/jpeg', 0.8));
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });
        };

        // --- Components ---
        const Toast = ({ message }) => (
            <div className="fixed top-4 left-1/2 transform -translate-x-1/2 bg-gray-900 text-white px-6 py-3 rounded-full shadow-2xl flex items-center gap-3 z-[100] animate-fade-in-down border border-gray-700/50 z-[9999]">
                <div className="w-2 h-2 rounded-full bg-green-400 animate-pulse"></div>
                <span className="font-medium">{message}</span>
            </div>
        );

        const Card = ({ children, title, icon: Icon, className = "", action }) => (
            <div className={`bg-white rounded-2xl shadow-sm border border-gray-200/60 overflow-hidden ${className}`}>
                {title && (
                    <div className="px-6 py-4 border-b border-gray-100 flex items-center justify-between bg-gradient-to-r from-gray-50/50 to-white">
                        <div className="flex items-center gap-2.5">
                            {Icon && <div className="p-2 bg-pink-50 rounded-lg text-pink-600"><Icon size={20} /></div>}
                            <h3 className="font-bold text-gray-800 text-lg">{title}</h3>
                        </div>
                        {action}
                    </div>
                )}
                <div className="p-6">{children}</div>
            </div>
        );

        // Sidebar Component
        const Sidebar = ({ activeTab, setActiveTab, user }) => (
            <div className="hidden md:flex flex-col w-64 bg-white border-r border-gray-200 h-screen sticky top-0">
                <div className="p-6 border-b border-gray-100">
                    <div className="flex items-center gap-2 text-pink-600 font-black text-xl tracking-tight">
                        <div className="bg-pink-100 p-2 rounded-xl"><Package size={24} className="text-pink-600" /></div>
                        OrderSystem
                    </div>
                </div>
                <div className="flex-1 p-4 space-y-2">
                    <button onClick={() => setActiveTab('form')} className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all font-medium ${activeTab === 'form' ? 'bg-pink-50 text-pink-700 shadow-sm' : 'text-gray-500 hover:bg-gray-50'}`}><Plus size={20} /><span>‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÉ‡∏´‡∏°‡πà</span></button>
                    <button onClick={() => setActiveTab('history')} className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all font-medium ${activeTab === 'history' ? 'bg-pink-50 text-pink-700 shadow-sm' : 'text-gray-500 hover:bg-gray-50'}`}><List size={20} /><span>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span></button>
                    <button onClick={() => setActiveTab('report')} className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all font-medium ${activeTab === 'report' ? 'bg-pink-50 text-pink-700 shadow-sm' : 'text-gray-500 hover:bg-gray-50'}`}><PieChart size={20} /><span>‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î</span></button>
                    <button onClick={() => setActiveTab('catalogue')} className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all font-medium ${activeTab === 'catalogue' ? 'bg-pink-50 text-pink-700 shadow-sm' : 'text-gray-500 hover:bg-gray-50'}`}><Grid size={20} /><span>‡πÅ‡∏Ñ‡∏ï‡∏ï‡∏≤‡∏•‡πá‡∏≠‡∏Å</span></button>
                    <button onClick={() => setActiveTab('docs')} className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all font-medium ${activeTab === 'docs' ? 'bg-pink-50 text-pink-700 shadow-sm' : 'text-gray-500 hover:bg-gray-50'}`}><Folder size={20} /><span>‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ (Drive)</span></button>
                </div>
                <div className="p-4 border-t border-gray-100">
                    <div className="bg-gray-50 p-3 rounded-xl flex items-center gap-3">
                        <div className={`w-2 h-2 rounded-full ${user ? 'bg-green-500' : 'bg-gray-300 animate-pulse'}`}></div>
                        <span className="text-sm text-gray-500 font-medium">Status: {user ? 'Online' : 'Connecting'}</span>
                    </div>
                </div>
            </div>
        );

        // BottomNav Component
        const BottomNav = ({ activeTab, setActiveTab }) => (
            <nav className="md:hidden fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 shadow-[0_-1px_3px_rgba(0,0,0,0.05)] z-30 pb-safe">
                <div className="flex justify-around items-center h-[65px]">
                    <button onClick={() => setActiveTab('form')} className={`flex flex-col items-center gap-1 w-full h-full justify-center ${activeTab === 'form' ? 'text-pink-600' : 'text-gray-400'}`}><div className={`p-1 rounded-full transition-all ${activeTab === 'form' ? 'bg-pink-50' : ''}`}><Plus size={24} /></div><span className="text-[10px] font-medium">‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</span></button>
                    <button onClick={() => setActiveTab('history')} className={`flex flex-col items-center gap-1 w-full h-full justify-center ${activeTab === 'history' ? 'text-pink-600' : 'text-gray-400'}`}><div className="relative"><div className={`p-1 rounded-full transition-all ${activeTab === 'history' ? 'bg-pink-50' : ''}`}><List size={24} /></div></div><span className="text-[10px] font-medium">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</span></button>
                    <button onClick={() => setActiveTab('report')} className={`flex flex-col items-center gap-1 w-full h-full justify-center ${activeTab === 'report' ? 'text-pink-600' : 'text-gray-400'}`}><div className={`p-1 rounded-full transition-all ${activeTab === 'report' ? 'bg-pink-50' : ''}`}><PieChart size={24} /></div><span className="text-[10px] font-medium">‡∏™‡∏£‡∏∏‡∏õ</span></button>
                    <button onClick={() => setActiveTab('catalogue')} className={`flex flex-col items-center gap-1 w-full h-full justify-center ${activeTab === 'catalogue' ? 'text-pink-600' : 'text-gray-400'}`}><div className={`p-1 rounded-full transition-all ${activeTab === 'catalogue' ? 'bg-pink-50' : ''}`}><Grid size={24} /></div><span className="text-[10px] font-medium">‡πÅ‡∏Ñ‡∏ï‡∏ï‡∏≤‡∏•‡πá‡∏≠‡∏Å</span></button>
                    <button onClick={() => setActiveTab('docs')} className={`flex flex-col items-center gap-1 w-full h-full justify-center ${activeTab === 'docs' ? 'text-pink-600' : 'text-gray-400'}`}><div className={`p-1 rounded-full transition-all ${activeTab === 'docs' ? 'bg-pink-50' : ''}`}><Folder size={24} /></div><span className="text-[10px] font-medium">‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£</span></button>
                </div>
            </nav>
        );

        // InvoiceA6 Component
        const InvoiceA6 = ({ order, id = "invoice-capture-area", scale = 1 }) => {
            if (!order) return null;
            const totalQty = order.items ? order.items.reduce((sum, i) => sum + i.quantity, 0) : 0;
            const totalAmount = order.totalAmount || order.items.reduce((sum, i) => sum + (i.total || 0), 0);
            const brandSummary = order.items.reduce((acc, item) => {
                acc[item.brand] = (acc[item.brand] || 0) + item.quantity;
                return acc;
            }, {});

            return (
                <div id={id} style={{
                    width: '397px', minHeight: '559px', backgroundColor: 'white', padding: '20px', boxSizing: 'border-box',
                    fontFamily: "'Sarabun', sans-serif", color: '#1f2937', position: 'relative', display: 'flex', flexDirection: 'column',
                    transform: `scale(${scale})`, transformOrigin: 'top left', marginBottom: `${(559 * scale) - 559}px`, marginRight: `${(397 * scale) - 397}px`
                }}>
                    <style>{`@import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@400;600;700&display=swap');`}</style>
                    <div style={{ borderBottom: '2px solid #db2777', paddingBottom: '10px', marginBottom: '15px', display: 'flex', justifyContent: 'space-between', alignItems: 'flex-end' }}>
                        <div style={{ fontSize: '20px', fontWeight: '800', color: '#db2777', lineHeight: '1' }}>ORDER<span style={{ color: '#1f2937' }}>SYSTEM</span></div>
                        <div style={{ fontSize: '12px', color: '#666', fontWeight: 'bold' }}>ORDER SHEET (A6)</div>
                    </div>
                    <div style={{ backgroundColor: '#fff1f2', padding: '10px', borderRadius: '6px', border: '1px solid #fbcfe8', marginBottom: '15px' }}>
                        <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '4px', fontSize: '12px' }}>
                            <div><span style={{ color: '#666' }}>‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤:</span> <span style={{ fontWeight: '700' }}>{order.shopName || '-'}</span></div>
                            <div><span style={{ color: '#666' }}>No:</span> <span style={{ fontWeight: '700' }}>{order.id === 'DRAFT' ? 'DRAFT' : order.id.slice(-4).toUpperCase()}</span></div>
                        </div>
                        <div style={{ display: 'flex', justifyContent: 'space-between', fontSize: '12px' }}>
                            <div><span style={{ color: '#666' }}>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</span> <span style={{ fontWeight: '700' }}>{order.orderDate}</span></div>
                            <div><span style={{ color: '#666' }}>‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢:</span> <span style={{ fontWeight: '700' }}>Admin</span></div>
                        </div>
                    </div>
                    <table style={{ width: '100%', borderCollapse: 'collapse', marginBottom: '15px', fontSize: '10px' }}>
                        <thead>
                            <tr style={{ backgroundColor: '#fce7f3', color: '#be185d' }}>
                                <th style={{ padding: '4px', textAlign: 'center', border: '1px solid #fbcfe8' }}>#</th>
                                <th style={{ padding: '4px', textAlign: 'left', border: '1px solid #fbcfe8' }}>‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                                <th style={{ padding: '4px', textAlign: 'left', border: '1px solid #fbcfe8' }}>‡∏™‡∏µ</th>
                                <th style={{ padding: '4px', textAlign: 'center', border: '1px solid #fbcfe8' }}>‡∏£‡∏≤‡∏Ñ‡∏≤</th>
                                <th style={{ padding: '4px', textAlign: 'center', border: '1px solid #fbcfe8' }}>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
                                <th style={{ padding: '4px', textAlign: 'right', border: '1px solid #fbcfe8' }}>‡∏£‡∏ß‡∏°</th>
                            </tr>
                        </thead>
                        <tbody>
                            {order.items.length === 0 ? (
                                <tr><td colSpan="6" style={{textAlign: 'center', padding: '20px', color: '#ccc'}}>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</td></tr>
                            ) : order.items.map((item, index) => (
                                <tr key={index} style={{ borderBottom: '1px solid #eee' }}>
                                    <td style={{ padding: '4px', textAlign: 'center' }}>{index + 1}</td>
                                    <td style={{ padding: '4px' }}>{item.brand}</td>
                                    <td style={{ padding: '4px' }}>{item.color}</td>
                                    <td style={{ padding: '4px', textAlign: 'center' }}>{item.price > 0 ? item.price : '-'}</td>
                                    <td style={{ padding: '4px', textAlign: 'center', fontWeight: 'bold' }}>{item.quantity} {item.unit || '‡πÇ‡∏´‡∏•'}</td>
                                    <td style={{ padding: '4px', textAlign: 'right' }}>{(item.total || 0).toLocaleString()}</td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                    <div style={{ marginBottom: '5px', borderBottom: '1px dashed #ddd', paddingBottom: '5px' }}>
                        <div style={{ fontSize: '8px', fontWeight: 'bold', color: '#666', marginBottom: '2px' }}>‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡πÅ‡∏ö‡∏£‡∏ô‡∏î‡πå:</div>
                        <div style={{ display: 'flex', flexWrap: 'wrap', gap: '4px' }}>
                            {Object.entries(brandSummary).map(([brand, qty]) => (
                                <span key={brand} style={{ fontSize: '7px', background: '#f3f4f6', padding: '1px 4px', borderRadius: '2px', border: '1px solid #e5e7eb' }}>
                                    {brand}: <strong>{qty}</strong>
                                </span>
                            ))}
                        </div>
                    </div>
                    <div style={{ marginTop: 'auto', borderTop: '1px solid #db2777', paddingTop: '10px', display: 'flex', flexDirection: 'column', alignItems: 'flex-end', gap: '4px' }}>
                        <div style={{ fontSize: '12px', display: 'flex', justifyContent: 'space-between', width: '100%' }}>
                            <span style={{ fontWeight: 'bold', color: '#666' }}>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</span>
                            <span style={{ fontWeight: '800', color: '#db2777' }}>{totalQty} <span style={{ fontSize: '10px', fontWeight: 'normal' }}>‡∏´‡∏ô‡πà‡∏ß‡∏¢</span></span>
                        </div>
                        <div style={{ fontSize: '14px', display: 'flex', justifyContent: 'space-between', width: '100%', borderTop: '1px dashed #fbcfe8', paddingTop: '4px' }}>
                            <span style={{ fontWeight: 'bold', color: '#db2777' }}>‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏¥‡πâ‡∏ô</span>
                            <span style={{ fontWeight: '800', color: '#db2777' }}>{totalAmount.toLocaleString()} <span style={{ fontSize: '10px', fontWeight: 'normal' }}>‡∏ö‡∏≤‡∏ó</span></span>
                        </div>
                    </div>
                    {order.note && (
                        <div style={{ marginTop: '10px', fontSize: '10px', border: '1px dashed #ccc', padding: '6px', borderRadius: '4px', backgroundColor: '#fafafa', width: '100%', boxSizing: 'border-box' }}>
                            <strong style={{color: '#666'}}>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏:</strong> {order.note}
                        </div>
                    )}
                    <div style={{ marginTop: '20px', display: 'flex', justifyContent: 'space-between' }}>
                        <div style={{ width: '40%', textAlign: 'center' }}>
                            <div style={{ borderBottom: '1px dotted #ccc', height: '20px', marginBottom: '4px' }}></div>
                            <div style={{ fontSize: '8px', color: '#999' }}>‡∏ú‡∏π‡πâ‡∏™‡πà‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</div>
                        </div>
                        <div style={{ width: '40%', textAlign: 'center' }}>
                            <div style={{ borderBottom: '1px dotted #ccc', height: '20px', marginBottom: '4px' }}></div>
                            <div style={{ fontSize: '8px', color: '#999' }}>‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</div>
                        </div>
                    </div>
                </div>
            );
        };

        // --- Error Boundary ---
        class ErrorBoundary extends React.Component {
            constructor(props) {
                super(props);
                this.state = { hasError: false };
            }
            static getDerivedStateFromError(error) {
                return { hasError: true };
            }
            componentDidCatch(error, errorInfo) {
                console.error("ErrorBoundary caught an error", error, errorInfo);
            }
            render() {
                if (this.state.hasError) {
                    return (
                        <div className="flex flex-col items-center justify-center min-h-[50vh] p-8 text-center bg-gray-50 rounded-xl border border-gray-200 m-4">
                            <div className="inline-block p-4 rounded-full bg-red-100 text-red-600 mb-4 shadow-sm">
                                <AlertTriangle size={48} />
                            </div>
                            <h2 className="text-xl font-bold text-gray-800 mb-2">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏ö‡∏≤‡∏á‡∏≠‡∏¢‡πà‡∏≤‡∏á</h2>
                            <p className="text-gray-500 mb-6">‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢‡πÉ‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏°‡πà‡∏™‡∏∞‡∏î‡∏ß‡∏Å ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö</p>
                            <button 
                                onClick={() => window.location.reload()} 
                                className="px-6 py-2.5 bg-red-600 text-white rounded-lg font-bold hover:bg-red-700 transition-colors shadow-lg shadow-red-200"
                            >
                                ‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö
                            </button>
                        </div>
                    );
                }
                return this.props.children;
            }
        }

        // --- Main App ---
        const App = () => {
            const [user, setUser] = useState(null);
            const [activeTab, setActiveTab] = useState('form');
            const [orders, setOrders] = useState([]);
            const [documents, setDocuments] = useState([]);
            const [toast, setToast] = useState(null);
            const [showPreview, setShowPreview] = useState(false);
            const [cartView, setCartView] = useState('list');
            const [customBrands, setCustomBrands] = useState({});
            const [editingBrand, setEditingBrand] = useState(null);
            const [orderForImg, setOrderForImg] = useState(null);

            // Form State
            const [shopName, setShopName] = useState('');
            const [orderDate, setOrderDate] = useState(new Date().toISOString().split('T')[0]);
            const [currentItems, setCurrentItems] = useState([]);
            const [note, setNote] = useState('');
            const [selectedBrand, setSelectedBrand] = useState(BRANDS[0]);
            const [selectedColor, setSelectedColor] = useState(COLORS[0]);
            const [quantity, setQuantity] = useState('');
            const [price, setPrice] = useState('');
            const [unit, setUnit] = useState(UNITS[0]);
            const [appId] = useState('default-app-id');

            // --- Helper Functions ---
            const showToast = (message) => {
                setToast(message);
                setTimeout(() => setToast(null), 3000);
            };

            const getTempOrder = () => ({
                id: 'DRAFT',
                shopName: shopName || '‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤',
                orderDate: orderDate,
                items: currentItems.length > 0 ? currentItems : [{brand: '‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á', color: '‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á', quantity: 12, unit: '‡πÇ‡∏´‡∏•', price: 100, total: 1200}],
                note: note,
                totalQuantity: currentItems.reduce((sum, i) => sum + i.quantity, 0),
                totalAmount: currentItems.reduce((sum, i) => sum + (i.total || 0), 0)
            });

            // --- Auth & Data ---
            useEffect(() => {
                const initFirebase = () => {
                    if (window.fb && window.fb.auth) {
                        window.fb.signInAnonymously(window.fb.auth).catch(e => console.error("Auth Failed", e));
                        window.fb.onAuthStateChanged(window.fb.auth, setUser);
                    } else {
                        window.addEventListener('firebase-ready', () => {
                            window.fb.signInAnonymously(window.fb.auth);
                            window.fb.onAuthStateChanged(window.fb.auth, setUser);
                        }, { once: true });
                    }
                };
                initFirebase();
            }, []);

            useEffect(() => {
                if (!user || !window.fb) return;
                const { db, collection, query, onSnapshot } = window.fb;
                const q = query(collection(db, 'artifacts', appId, 'users', user.uid, 'orders'));
                return onSnapshot(q, (snapshot) => {
                    const loadedOrders = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    loadedOrders.sort((a, b) => {
                        const dateA = a.createdAt?.toDate ? a.createdAt.toDate() : new Date(0);
                        const dateB = b.createdAt?.toDate ? b.createdAt.toDate() : new Date(0);
                        return dateB - dateA;
                    });
                    setOrders(loadedOrders);
                });
            }, [user]);

            useEffect(() => {
                if (!user || !window.fb) return;
                const { db, collection, query, onSnapshot, orderBy } = window.fb;
                const q = query(collection(db, 'artifacts', appId, 'users', user.uid, 'documents'), orderBy('createdAt', 'desc'));
                return onSnapshot(q, (snapshot) => {
                    setDocuments(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                }, (e) => console.log("Docs Error", e));
            }, [user]);

            useEffect(() => {
                if (!user || !window.fb) return;
                const { db, collection, query, onSnapshot } = window.fb;
                const q = query(collection(db, 'artifacts', appId, 'users', user.uid, 'brands'));
                return onSnapshot(q, (snapshot) => {
                    const loadedBrands = {};
                    snapshot.docs.forEach(doc => loadedBrands[doc.id] = doc.data());
                    setCustomBrands(loadedBrands);
                });
            }, [user]);

            useEffect(() => {
                const customPrice = customBrands[selectedBrand]?.price;
                const defaultPrice = BRAND_PRICES[selectedBrand];
                if (customPrice !== undefined) setPrice(customPrice);
                else if (defaultPrice !== undefined) setPrice(defaultPrice);
                else setPrice('');
            }, [selectedBrand, customBrands]);

            const savedShops = useMemo(() => {
                const uniqueNames = new Set(orders.map(o => o.shopName).filter(n => n && n.trim() !== ''));
                return Array.from(uniqueNames).sort();
            }, [orders]);

            const reportStats = useMemo(() => {
                const stats = {};
                orders.forEach(order => {
                    const date = new Date(order.orderDate);
                    const year = date.getFullYear();
                    const month = date.toLocaleString('th-TH', { month: 'long' });
                    const shop = order.shopName || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô';
                    const total = order.totalAmount || 0;
                    const qty = order.totalQuantity || 0;
                    if (!stats[shop]) stats[shop] = { yearly: {} };
                    if (!stats[shop].yearly[year]) stats[shop].yearly[year] = { total: 0, qty: 0, monthly: {} };
                    stats[shop].yearly[year].total += total;
                    stats[shop].yearly[year].qty += qty;
                    if (!stats[shop].yearly[year].monthly[month]) stats[shop].yearly[year].monthly[month] = { total: 0, qty: 0, count: 0 };
                    stats[shop].yearly[year].monthly[month].total += total;
                    stats[shop].yearly[year].monthly[month].qty += qty;
                    stats[shop].yearly[year].monthly[month].count += 1;
                });
                return stats;
            }, [orders]);

            const cartBrandSummary = useMemo(() => {
                const summary = {};
                currentItems.forEach(item => { if (!summary[item.brand]) summary[item.brand] = 0; summary[item.brand] += item.quantity; });
                return Object.entries(summary);
            }, [currentItems]);

            const stats = useMemo(() => {
                let totalItems = 0; let totalRevenue = 0;
                const brandCounts = {}; const colorCounts = {};
                orders.forEach(o => {
                  totalItems += o.totalQuantity || 0; totalRevenue += o.totalAmount || 0;
                  o.items?.forEach(i => {
                    brandCounts[i.brand] = (brandCounts[i.brand] || 0) + i.quantity;
                    colorCounts[i.color] = (colorCounts[i.color] || 0) + i.quantity;
                  });
                });
                const brandData = Object.entries(brandCounts).map(([name, value]) => ({ name, value })).sort((a, b) => b.value - a.value);
                const colorData = Object.entries(colorCounts).map(([name, value]) => ({ name, value })).sort((a, b) => b.value - a.value).slice(0, 10);
                return { totalOrders: orders.length, totalItems, totalRevenue, brandData, colorData };
            }, [orders]);

            const handleBrandSave = async (brandName, newPrice, file) => {
                if(!user) return;
                let imageUrl = customBrands[brandName]?.image;
                if(file) imageUrl = await resizeImage(file);
                await window.fb.setDoc(window.fb.doc(window.fb.db, 'artifacts', appId, 'users', user.uid, 'brands', brandName), {
                    price: newPrice, image: imageUrl || BRAND_IMAGES[brandName] || ''
                }, { merge: true });
                setEditingBrand(null);
                showToast("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ö‡∏£‡∏ô‡∏î‡πå‡πÅ‡∏•‡πâ‡∏ß");
            }

            const handleAddItem = () => {
                if (!quantity || parseInt(quantity) <= 0) return showToast("‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤");
                const unitPrice = parseFloat(price) || 0;
                const qty = parseInt(quantity);
                const newItem = {
                    id: Date.now(), brand: selectedBrand, color: selectedColor, quantity: qty, unit: unit, price: unitPrice, total: unitPrice * qty
                };
                setCurrentItems([...currentItems, newItem]);
                setQuantity('');
                showToast("‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏á‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß");
            };

            const handleRemoveItem = (id) => setCurrentItems(currentItems.filter(item => item.id !== id));

            const handleSaveOrder = async () => {
                if (!user) return showToast("‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà ‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠...");
                if (!shopName) return showToast("‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤");
                if (currentItems.length === 0) return showToast("‚ö†Ô∏è ‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤");
                try {
                    const totalQty = currentItems.reduce((sum, item) => sum + item.quantity, 0);
                    const totalAmount = currentItems.reduce((sum, item) => sum + (item.total || 0), 0);
                    const { addDoc, collection, db, serverTimestamp } = window.fb;
                    await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'orders'), {
                        shopName, orderDate, items: currentItems, note: note, totalQuantity: totalQty, totalAmount: totalAmount, createdAt: serverTimestamp()
                    });
                    setShopName('');
                    setCurrentItems([]);
                    const customPrice = customBrands[selectedBrand]?.price;
                    const defaultPrice = BRAND_PRICES[selectedBrand];
                    setPrice(customPrice !== undefined ? customPrice : (defaultPrice !== undefined ? defaultPrice : ''));
                    setNote(''); 
                    setActiveTab('history'); 
                    showToast("üéâ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
                } catch (error) { console.error(error); showToast("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î"); }
            };

            const handleDeleteOrder = async (orderId) => {
                if(!confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ô‡∏µ‡πâ?")) return;
                await window.fb.deleteDoc(window.fb.doc(window.fb.db, 'artifacts', appId, 'users', user.uid, 'orders', orderId));
                showToast("‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
            }

            const handleFullPrint = (order) => {
                const printWindow = window.open('', '_blank');
                if (!printWindow) return alert('Blocked');
                const totalQty = order.items.reduce((sum, i) => sum + i.quantity, 0);
                const totalAmount = order.totalAmount || order.items.reduce((s, i) => s + (i.total || 0), 0);
                printWindow.document.write(`
                    <html><head><title>Order ${order.shopName}</title><style>body{font-family:sans-serif;padding:20px}table{width:100%;border-collapse:collapse;margin-top:20px}th,td{border:1px solid #ddd;padding:8px;text-align:left}th{background:#f0f0f0}.header{display:flex;justify-content:space-between;margin-bottom:20px;border-bottom:2px solid #db2777;padding-bottom:10px}</style></head><body>
                    <div class="header"><h1>ORDER SHEET</h1><div><div><strong>‡∏£‡πâ‡∏≤‡∏ô:</strong> ${order.shopName}</div><div><strong>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</strong> ${order.orderDate}</div></div></div>
                    <table><thead><tr><th>‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th><th>‡∏™‡∏µ</th><th>‡∏£‡∏≤‡∏Ñ‡∏≤</th><th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th><th>‡∏£‡∏ß‡∏°</th></tr></thead><tbody>${order.items.map(i => `<tr><td>${i.brand}</td><td>${i.color}</td><td>${i.price}</td><td>${i.quantity} ${i.unit}</td><td>${i.total?.toLocaleString()}</td></tr>`).join('')}</tbody><tfoot><tr><td colspan="3" style="text-align:right"><strong>‡∏£‡∏ß‡∏°‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</strong></td><td><strong>${totalQty}</strong></td><td><strong>${totalAmount?.toLocaleString()}</strong></td></tr></tfoot></table>
                    ${order.note ? `<p><strong>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏:</strong> ${order.note}</p>` : ''}<script>window.print();<\/script></body></html>`);
                printWindow.document.close();
            }

            const handleSaveImage = (order) => {
                setOrderForImg(order);
                showToast("‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û...");
                setTimeout(async () => {
                    const element = document.getElementById('invoice-capture-area');
                    if (element && window.html2canvas) {
                        try {
                            const canvas = await window.html2canvas(element, { scale: 2, useCORS: true, backgroundColor: '#ffffff' });
                            const link = document.createElement('a');
                            link.download = `Order_${order.shopName}.png`;
                            link.href = canvas.toDataURL('image/png');
                            link.click();
                            showToast("üì∏ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
                        } catch (err) { console.error(err); showToast("‚ùå ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß"); }
                    }
                    setOrderForImg(null); 
                }, 800);
            };
            
            const handleAddDocument = async (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                const docData = { name: formData.get('name'), url: formData.get('url'), category: formData.get('category'), createdAt: window.fb.serverTimestamp() };
                if(!user) return;
                await window.fb.addDoc(window.fb.collection(window.fb.db, 'artifacts', appId, 'users', user.uid, 'documents'), docData);
                e.target.reset();
                showToast("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß");
            };
            
            const handleDeleteDocument = async (id) => {
                if(!confirm("‡∏•‡∏ö‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ô‡∏µ‡πâ?")) return;
                await window.fb.deleteDoc(window.fb.doc(window.fb.db, 'artifacts', appId, 'users', user.uid, 'documents', id));
                showToast("‡∏•‡∏ö‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß");
            };

            const handleExportCSV = () => {
                if (orders.length === 0) return showToast("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏≠‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô");
                let csvContent = "\uFEFF‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà,‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤,‡πÅ‡∏ö‡∏£‡∏ô‡∏î‡πå,‡∏™‡∏µ/‡∏£‡∏´‡∏±‡∏™,‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢,‡∏à‡∏≥‡∏ô‡∏ß‡∏ô,‡∏´‡∏ô‡πà‡∏ß‡∏¢,‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ß‡∏°,‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏\n";
                orders.forEach(order => {
                    order.items.forEach(item => {
                        const row = [`"${order.orderDate}"`, `"${order.shopName}"`, `"${item.brand}"`, `"${item.color}"`, `"${item.price}"`, `"${item.quantity}"`, `"${item.unit || '‡πÇ‡∏´‡∏•'}"`, `"${item.total || 0}"`, `"${order.note || ''}"`];
                        csvContent += row.join(",") + "\n";
                    });
                });
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement("a");
                link.setAttribute("href", url);
                link.setAttribute("download", `Order_Export_${new Date().toISOString().slice(0,10)}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                showToast("üìä ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î CSV ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
            };

            // Sub-Components
            const EditBrandModal = () => {
                const [lPrice, setLPrice] = useState(editingBrand?.price || '');
                const [file, setFile] = useState(null);
                const [preview, setPreview] = useState(editingBrand?.image || null);
                const [loading, setLoading] = useState(false);
                const onFileChange = (e) => {
                    if (e.target.files && e.target.files[0]) {
                        const f = e.target.files[0];
                        setFile(f);
                        const reader = new FileReader();
                        reader.onload = (ev) => setPreview(ev.target.result);
                        reader.readAsDataURL(f);
                    }
                }
                const onSave = async () => {
                    setLoading(true);
                    await handleBrandSave(editingBrand.name, lPrice, file);
                    setLoading(false);
                }
                return (
                    <div className="fixed inset-0 z-[70] flex items-center justify-center bg-black/80 p-4" onClick={() => setEditingBrand(null)}>
                        <div className="bg-white rounded-xl overflow-hidden max-w-sm w-full shadow-2xl p-6" onClick={e => e.stopPropagation()}>
                            <h3 className="font-bold text-lg mb-4 flex items-center gap-2 text-gray-800"><Edit2 size={20} className="text-pink-600" /> ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: {editingBrand.name}</h3>
                            <div className="space-y-4">
                                <div><label className="block text-sm font-medium text-gray-700 mb-1">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô (‡∏ö‡∏≤‡∏ó)</label><input type="number" value={lPrice} onChange={e => setLPrice(e.target.value)} className="w-full p-2 border rounded-lg"/></div>
                                <div><label className="block text-sm font-medium text-gray-700 mb-1">‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label><div className="flex items-center gap-4"><div className="w-20 h-20 bg-gray-100 rounded-lg overflow-hidden border border-gray-200">{preview ? <img src={preview} className="w-full h-full object-cover" /> : <div className="w-full h-full flex items-center justify-center text-gray-400">?</div>}</div><label className="flex-1 cursor-pointer bg-gray-50 border border-dashed border-gray-300 rounded-lg h-20 flex flex-col items-center justify-center text-gray-500 hover:bg-gray-100 hover:text-pink-600 transition-colors"><Upload size={20} className="mb-1" /><span className="text-xs">‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ</span><input type="file" className="hidden" accept="image/*" onChange={onFileChange} /></label></div></div>
                            </div>
                            <div className="mt-6 flex gap-2"><button onClick={() => setEditingBrand(null)} className="flex-1 py-2 text-gray-600 font-medium hover:bg-gray-50 rounded-lg">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button><button onClick={onSave} disabled={loading} className="flex-1 py-2 bg-pink-600 text-white font-medium rounded-lg hover:bg-pink-700 flex items-center justify-center gap-2">{loading && <Loader size={16} className="animate-spin" />} ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button></div>
                        </div>
                    </div>
                );
            }

            const DocumentView = () => (
                <div className="space-y-6 max-w-7xl mx-auto animate-fade-in pb-24">
                    <div className="bg-white rounded-xl p-6 shadow-sm border border-gray-200">
                        <h2 className="text-xl font-bold text-gray-800 mb-2 flex items-center gap-2"><Folder size={24} className="text-pink-600" /> ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ Google Drive</h2>
                        <form onSubmit={handleAddDocument} className="grid grid-cols-1 md:grid-cols-4 gap-3 bg-gray-50 p-4 rounded-lg border border-gray-100">
                            <div className="md:col-span-1"><input required name="name" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£..." className="w-full p-2 border rounded-lg text-sm" /></div>
                            <div className="md:col-span-1"><select name="category" className="w-full p-2 border rounded-lg text-sm">{DOC_CATEGORIES.map(c => <option key={c} value={c}>{c}</option>)}</select></div>
                            <div className="md:col-span-1"><input required name="url" type="url" placeholder="‡∏ß‡∏≤‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå Google Drive..." className="w-full p-2 border rounded-lg text-sm" /></div>
                            <button type="submit" className="bg-pink-600 text-white rounded-lg px-4 py-2 text-sm font-bold hover:bg-pink-700">‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£</button>
                        </form>
                    </div>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        {documents.map(doc => (
                            <div key={doc.id} className="bg-white p-4 rounded-xl shadow-sm border border-gray-200 flex justify-between items-center hover:shadow-md transition-all">
                                <div className="flex items-center gap-3 overflow-hidden">
                                    <div className="w-10 h-10 bg-blue-50 text-blue-600 rounded-lg flex items-center justify-center flex-shrink-0"><FileText size={20} /></div>
                                    <div className="min-w-0"><div className="font-bold text-gray-800 truncate">{doc.name}</div><div className="text-xs text-gray-500 flex items-center gap-2"><span className="bg-gray-100 px-2 py-0.5 rounded">{doc.category}</span>{doc.createdAt?.toDate && <span>{doc.createdAt.toDate().toLocaleDateString('th-TH')}</span>}</div></div>
                                </div>
                                <div className="flex items-center gap-2"><a href={doc.url} target="_blank" rel="noreferrer" className="p-2 text-gray-500 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition-colors"><ExternalLink size={20} /></a><button onClick={() => handleDeleteDocument(doc.id)} className="p-2 text-gray-400 hover:text-red-600 hover:bg-red-50 rounded-lg transition-colors"><Trash2 size={20} /></button></div>
                            </div>
                        ))}
                        {documents.length === 0 && <div className="col-span-full text-center py-10 text-gray-400">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ</div>}
                    </div>
                </div>
            );

            const ReportView = () => (
                <div className="space-y-6 max-w-7xl mx-auto animate-fade-in pb-20">
                    <h3 className="font-bold text-gray-800 text-xl flex items-center gap-2"><PieChart size={24} className="text-pink-600" /> ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤</h3>
                    <div className="grid grid-cols-1 gap-4">
                        {Object.keys(reportStats).length === 0 ? <div className="text-center py-20 bg-white rounded-2xl border-2 border-dashed border-gray-200"><Store size={64} className="text-gray-300 mx-auto mb-4" /><h3 className="text-gray-500 font-medium">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢</h3></div> : 
                        Object.entries(reportStats).sort().map(([shopName, shopData]) => (
                            <div key={shopName} className="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                                <div className="p-4 bg-gray-50 border-b border-gray-200 flex justify-between items-center"><div className="font-bold text-lg text-gray-800 flex items-center gap-2"><Store size={20} className="text-gray-500" />{shopName}</div></div>
                                <div className="p-4">{Object.entries(shopData.yearly).sort((a, b) => b[0] - a[0]).map(([year, yearData]) => (
                                    <div key={year} className="mb-6 last:mb-0"><div className="flex items-center gap-4 mb-3 pb-2 border-b border-gray-100"><div className="bg-pink-100 text-pink-700 px-3 py-1 rounded-lg font-bold text-sm">‡∏õ‡∏µ {year}</div><div className="text-sm font-medium text-gray-600">‡∏£‡∏ß‡∏°: <span className="text-pink-600 font-bold ml-1">‡∏ø{yearData.total.toLocaleString()}</span> | <span className="text-gray-600 font-bold">{yearData.qty} ‡∏´‡∏ô‡πà‡∏ß‡∏¢</span></div></div>
                                        <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3">{Object.entries(yearData.monthly).map(([month, monthData]) => (<div key={month} className="bg-gray-50 rounded-lg p-3 border border-gray-100 flex flex-col"><div className="text-gray-500 text-xs font-medium mb-1">{month}</div><div className="flex justify-between items-end mt-auto"><div className="text-lg font-bold text-gray-800">‡∏ø{monthData.total.toLocaleString()}</div><div className="text-xs text-gray-500 bg-white px-2 py-0.5 rounded border border-gray-200">{monthData.qty} ‡∏ä‡∏¥‡πâ‡∏ô</div></div></div>))}</div>
                                    </div>))}
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );

            const CatalogueView = () => (
                <div className="space-y-8 max-w-7xl mx-auto animate-fade-in pb-24">
                    <div className="bg-white rounded-xl p-6 shadow-sm border border-gray-200 text-center"><h2 className="text-2xl font-black text-gray-800 mb-2">CATALOGUE 2026</h2><p className="text-gray-500">‡∏£‡∏ß‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡∏∞‡πÄ‡∏â‡∏î‡∏™‡∏µ</p></div>
                    <div><h3 className="font-bold text-gray-700 text-lg mb-4 flex items-center gap-2"><Package size={20} className="text-pink-600" /> ‡πÅ‡∏ö‡∏£‡∏ô‡∏î‡πå‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h3>
                        <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4">
                            {BRANDS.map(brand => {
                                const brandData = customBrands[brand] || {};
                                const price = brandData.price !== undefined ? brandData.price : BRAND_PRICES[brand];
                                const image = brandData.image || BRAND_IMAGES[brand];
                                return (
                                <div key={brand} className="bg-white p-4 rounded-xl shadow-sm border border-gray-200 flex flex-col items-center justify-center gap-3 hover:shadow-md transition-all group relative overflow-hidden">
                                    <button onClick={() => setEditingBrand({name: brand, price: price, image: image})} className="absolute top-2 right-2 bg-white/80 p-1.5 rounded-full text-gray-500 hover:text-pink-600 hover:bg-white shadow-sm opacity-0 group-hover:opacity-100 transition-all z-20"><Edit2 size={16} /></button>
                                    <div className="w-24 h-24 bg-gray-100 rounded-full flex items-center justify-center text-2xl font-bold text-gray-400 group-hover:bg-pink-50 transition-colors overflow-hidden">
                                        {image ? <img src={image} alt={brand} className="w-full h-full object-cover" /> : brand.charAt(0)}
                                    </div>
                                    <div className="text-center z-10 w-full"><div className="font-bold text-gray-800 truncate">{brand}</div>{price && <div className="text-xs text-pink-600 font-medium bg-pink-50 px-2 py-0.5 rounded mt-1 inline-block">‡∏ø{price} / ‡πÇ‡∏´‡∏•</div>}</div>
                                </div>
                            )})}
                        </div>
                    </div>
                    <div><h3 className="font-bold text-gray-700 text-lg mb-4 flex items-center gap-2"><Palette size={20} className="text-blue-600" /> ‡πÄ‡∏â‡∏î‡∏™‡∏µ‡πÅ‡∏•‡∏∞‡∏£‡∏´‡∏±‡∏™</h3>
                        <div className="grid grid-cols-2 sm:grid-cols-4 md:grid-cols-6 lg:grid-cols-8 gap-4">{COLORS.map(color => (<div key={color} className="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden hover:shadow-md transition-all"><div className="h-24 w-full" style={{ background: COLOR_VISUALS[color] || '#eee' }} /><div className="p-3 text-center"><div className="font-bold text-gray-700 text-sm">{color}</div></div></div>))}</div>
                    </div>
                </div>
            );

            // --- Render Main Layout ---
            return (
                <div className="flex min-h-screen bg-gray-50 font-sans text-gray-800">
                    <div style={{ position: 'fixed', left: '-9999px', top: 0 }}>{orderForImg && <InvoiceA6 order={orderForImg} />}</div>
                    {editingBrand && <EditBrandModal />}
                    {showPreview && (
                        <div className="fixed inset-0 z-[60] flex items-center justify-center bg-black/80 p-4" onClick={() => setShowPreview(false)}>
                            <div className="bg-white rounded-xl overflow-hidden max-w-sm w-full max-h-[90vh] flex flex-col shadow-2xl" onClick={e => e.stopPropagation()}>
                                <div className="p-3 bg-gray-100 border-b border-gray-200 flex justify-between items-center"><h3 className="font-bold text-gray-700 flex items-center gap-2"><Eye size={16} /> ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á</h3><button onClick={() => setShowPreview(false)} className="text-gray-400 hover:text-gray-600"><X size={20} /></button></div>
                                <div className="flex-1 overflow-y-auto custom-scrollbar p-1 bg-gray-200 flex justify-center"><div className="scale-90 origin-top"><InvoiceA6 order={getTempOrder()} id="invoice-mobile-preview" /></div></div>
                                <button onClick={() => setShowPreview(false)} className="w-full py-3.5 bg-white border-t border-gray-200 font-bold text-gray-600 hover:bg-gray-50">‡∏õ‡∏¥‡∏î</button>
                            </div>
                        </div>
                    )}

                    <Sidebar activeTab={activeTab} setActiveTab={setActiveTab} user={user} />

                    <main className="flex-1 w-full md:px-8 md:py-8 px-4 py-5 overflow-y-auto h-screen pb-24 md:pb-8">
                        <header className="md:hidden flex justify-between items-center mb-6"><div className="flex items-center gap-2 text-pink-600 font-black text-xl"><div className="bg-pink-100 p-1.5 rounded-lg"><Package size={20} className="text-pink-600" /></div>Order App</div><div className={`w-2 h-2 rounded-full ${user ? 'bg-green-500' : 'bg-gray-300 animate-pulse'}`}></div></header>

                        <ErrorBoundary>
                        {activeTab === 'form' && (
                            <div className="md:grid md:grid-cols-12 md:gap-8 max-w-7xl mx-auto animate-fade-in">
                                <div className="md:col-span-7 space-y-6">
                                    <div className="md:flex md:gap-6">
                                        <Card title="‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤" icon={Store} className="flex-1">
                                            <div className="grid gap-4">
                                                <div><label className="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-1 block">‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤</label><div className="relative"><input type="text" list="shop-list" value={shopName} onChange={(e) => setShopName(e.target.value)} placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏£‡πâ‡∏≤‡∏ô‡πÄ‡∏à‡πä‡∏™‡∏°‡∏®‡∏£‡∏µ..." className="w-full pl-10 p-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-pink-400 focus:bg-white transition-all outline-none text-gray-800 font-medium"/><datalist id="shop-list">{savedShops.map(name => <option key={name} value={name} />)}</datalist><div className="absolute left-3 top-3.5 text-gray-400"><Store size={20} /></div></div></div>
                                                <div><label className="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-1 block">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label><div className="relative"><input type="date" value={orderDate} onChange={(e) => setOrderDate(e.target.value)} className="w-full pl-10 p-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-pink-400 focus:bg-white outline-none text-gray-800"/><div className="absolute left-3 top-3.5 text-gray-400"><Calendar size={20} /></div></div></div>
                                            </div>
                                        </Card>
                                    </div>
                                    <Card title="‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤" icon={Package}>
                                        <div className="space-y-4">
                                            <div className="grid grid-cols-12 gap-4">
                                                <div className="col-span-8 md:col-span-7 space-y-1"><label className="text-xs font-semibold text-gray-500 uppercase tracking-wider">‡πÅ‡∏ö‡∏£‡∏ô‡∏î‡πå</label><div className="relative"><select value={selectedBrand} onChange={(e) => setSelectedBrand(e.target.value)} className="w-full p-3 pl-12 bg-gray-50 border border-gray-200 rounded-xl outline-none focus:ring-2 focus:ring-pink-400 transition-all cursor-pointer appearance-none">{BRANDS.map(b => <option key={b} value={b}>{b}</option>)}</select><div className="absolute left-2 top-2 w-8 h-8 rounded-lg overflow-hidden border border-gray-200 bg-white">{(customBrands[selectedBrand]?.image || BRAND_IMAGES[selectedBrand]) ? <img src={customBrands[selectedBrand]?.image || BRAND_IMAGES[selectedBrand]} className="w-full h-full object-cover" alt="" /> : <div className="w-full h-full flex items-center justify-center bg-gray-100 text-xs text-gray-400 font-bold">{selectedBrand.charAt(0)}</div>}</div></div></div>
                                                <div className="col-span-4 md:col-span-5 space-y-1"><label className="text-xs font-semibold text-gray-500 uppercase tracking-wider">‡∏£‡∏≤‡∏Ñ‡∏≤</label><div className="relative"><input type="number" value={price} onChange={(e) => setPrice(e.target.value)} placeholder="0" className="w-full pl-8 p-3 border border-gray-200 rounded-xl outline-none focus:ring-2 focus:ring-pink-400"/><span className="absolute left-3 top-3.5 text-gray-400 text-sm">‡∏ø</span></div></div>
                                                <div className="col-span-12 space-y-1"><label className="text-xs font-semibold text-gray-500 uppercase tracking-wider">‡∏™‡∏µ/‡∏£‡∏´‡∏±‡∏™</label><div className="relative"><select value={selectedColor} onChange={(e) => setSelectedColor(e.target.value)} className="w-full p-3 pl-10 bg-gray-50 border border-gray-200 rounded-xl outline-none focus:ring-2 focus:ring-pink-400 transition-all cursor-pointer">{COLORS.map(c => <option key={c} value={c}>{c}</option>)}</select><div className="absolute left-3 top-3.5 w-4 h-4 rounded-full border border-gray-300 shadow-sm" style={{ background: COLOR_VISUALS[selectedColor] || '#eee' }}/></div></div>
                                            </div>
                                            <div className="flex gap-3 items-end pt-2">
                                                <div className="flex-1 space-y-1"><label className="text-xs font-semibold text-gray-500 uppercase tracking-wider">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</label><div className="relative"><input type="number" value={quantity} onChange={(e) => setQuantity(e.target.value)} onKeyDown={(e) => e.key === 'Enter' && handleAddItem()} placeholder="0" className="w-full pl-4 p-3 border-2 border-pink-100 rounded-xl outline-none focus:border-pink-500 text-lg font-bold text-gray-700"/></div></div>
                                                <div className="w-24 space-y-1"><label className="text-xs font-semibold text-gray-500 uppercase tracking-wider">‡∏´‡∏ô‡πà‡∏ß‡∏¢</label><select value={unit} onChange={(e) => setUnit(e.target.value)} className="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl outline-none focus:ring-2 focus:ring-pink-400">{UNITS.map(u => <option key={u} value={u}>{u}</option>)}</select></div>
                                                <button onClick={handleAddItem} className="h-[54px] px-6 bg-pink-600 text-white rounded-xl shadow-md hover:bg-pink-700 active:scale-95 transition-all flex items-center justify-center gap-2 font-bold"><Plus size={24} /><span className="hidden md:inline">‡πÄ‡∏û‡∏¥‡πà‡∏°</span></button>
                                            </div>
                                        </div>
                                    </Card>
                                </div>
                                <div className="md:col-span-5 mt-6 md:mt-0">
                                    <div className="md:sticky md:top-6 space-y-4">
                                        <div className="bg-white rounded-2xl shadow-lg border border-pink-100 overflow-hidden flex flex-col h-[calc(100vh-80px)]">
                                            <div className="bg-pink-600 text-white p-3 flex justify-between items-center">
                                                <div className="flex items-center gap-2 font-bold">{cartView === 'list' ? <ShoppingCart size={20} /> : <FileText size={20} />}{cartView === 'list' ? '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤' : '‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à'}</div>
                                                <div className="hidden md:flex bg-pink-700/50 p-1 rounded-lg">
                                                    <button onClick={() => setCartView('list')} className={`px-3 py-1 rounded-md text-xs font-bold transition-all ${cartView === 'list' ? 'bg-white text-pink-600 shadow-sm' : 'text-pink-100 hover:bg-pink-600'}`}>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
                                                    <button onClick={() => setCartView('invoice')} className={`px-3 py-1 rounded-md text-xs font-bold transition-all ${cartView === 'invoice' ? 'bg-white text-pink-600 shadow-sm' : 'text-pink-100 hover:bg-pink-600'}`}>‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à</button>
                                                </div>
                                                <span className="md:hidden bg-white/20 px-2 py-0.5 rounded text-sm font-bold">{currentItems.length}</span>
                                            </div>
                                            <div className="flex-1 overflow-y-auto custom-scrollbar bg-gray-50 relative">
                                                {cartView === 'list' ? (
                                                    <div className="p-2 space-y-2 min-h-[200px]">
                                                        {currentItems.length === 0 ? <div className="h-40 flex flex-col items-center justify-center text-gray-400 opacity-60"><Package size={48} className="mb-2" strokeWidth={1.5} /><p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</p></div> : currentItems.map((item) => (
                                                            <div key={item.id} className="bg-white p-3 rounded-xl shadow-sm border border-gray-100 flex justify-between items-center group">
                                                                <div className="flex-1"><div className="font-bold text-gray-700 flex justify-between"><span>{item.brand}</span>{item.price > 0 && <span className="text-gray-400 text-xs font-normal">‡∏ø{item.price}</span>}</div><div className="text-xs text-gray-500 bg-gray-100 inline-block px-1.5 py-0.5 rounded mt-1">{item.color}</div></div>
                                                                <div className="flex items-center gap-3 pl-3"><div className="text-right"><div className="font-bold text-pink-600 text-lg">x{item.quantity} <span className="text-xs font-normal text-gray-500">{item.unit}</span></div>{item.total > 0 && <div className="text-[10px] text-gray-400">‡∏ø{item.total.toLocaleString()}</div>}</div><button onClick={() => handleRemoveItem(item.id)} className="text-gray-300 hover:text-red-500 transition-colors p-1"><X size={20} /></button></div>
                                                            </div>
                                                        ))}
                                                        {currentItems.length > 0 && <div className="px-2 py-2 mt-4 bg-white rounded-lg border border-gray-100 shadow-sm"><div className="flex items-center gap-2 mb-2"><Layers size={12} className="text-gray-400" /><span className="text-xs font-semibold text-gray-500 uppercase tracking-wider">‡∏™‡∏£‡∏∏‡∏õ‡πÅ‡∏ö‡∏£‡∏ô‡∏î‡πå</span></div><div className="flex flex-wrap gap-2">{cartBrandSummary.map(([brand, qty]) => (<div key={brand} className="bg-gray-50 px-2 py-1 rounded border border-gray-200 text-xs text-gray-600 flex items-center gap-1"><span>{brand}:</span><span className="font-bold text-pink-600">{qty}</span></div>))}</div></div>}
                                                    </div>
                                                ) : (<div className="flex justify-center p-4 min-h-full items-start bg-gray-200"><InvoiceA6 order={getTempOrder()} id="invoice-live-preview" scale={0.85} /></div>)}
                                            </div>
                                            <div className="bg-white border-t border-gray-100 flex flex-col">
                                                {cartView === 'list' && (
                                                    <div className="px-4 pb-2 pt-2"><div className="flex items-center gap-2 mb-1"><MessageSquare size={12} className="text-gray-400" /><label className="text-xs font-semibold text-gray-500 uppercase tracking-wider">‡πÇ‡∏ô‡πâ‡∏ï / ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label></div><textarea value={note} onChange={(e) => setNote(e.target.value)} placeholder="..." className="w-full p-2 bg-gray-50 border border-gray-200 rounded-lg text-sm outline-none focus:ring-2 focus:ring-pink-400 resize-none h-12 transition-all"/></div>
                                                )}
                                                <div className="p-4 pt-2">
                                                    <div className="flex justify-between items-center mb-2 text-gray-700"><span className="text-sm">‡∏£‡∏ß‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</span><span className="font-bold text-lg text-gray-600">{currentItems.reduce((s, i) => s + i.quantity, 0)} <span className="text-sm font-normal">‡∏´‡∏ô‡πà‡∏ß‡∏¢</span></span></div>
                                                    <div className="flex justify-between items-center mb-4 text-gray-700"><span className="text-sm">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡πÄ‡∏á‡∏¥‡∏ô</span><span className="font-bold text-xl text-pink-600">‡∏ø{currentItems.reduce((s, i) => s + (i.total || 0), 0).toLocaleString()}</span></div>
                                                    <div className="flex gap-2"><button onClick={() => setShowPreview(true)} className="md:hidden flex-1 py-4 rounded-xl font-bold text-lg border-2 border-gray-200 text-gray-600 hover:bg-gray-50 flex items-center justify-center gap-2 transition-all active:scale-[0.98]"><Eye size={20} /></button><button onClick={handleSaveOrder} disabled={currentItems.length === 0} className={`flex-[2] py-4 rounded-xl font-bold text-lg shadow-lg flex items-center justify-center gap-2 transition-all active:scale-[0.98] ${currentItems.length > 0 ? 'bg-gradient-to-r from-pink-600 to-rose-600 text-white hover:shadow-pink-200/50 hover:-translate-y-0.5' : 'bg-gray-200 text-gray-400 cursor-not-allowed'}`}><Save size={20} />‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}

                        {activeTab === 'history' && (
                           <div className="space-y-6 max-w-7xl mx-auto animate-fade-in">
                               <div className="grid grid-cols-2 md:grid-cols-3 gap-4">
                                   <Card className="bg-gradient-to-br from-pink-500 to-rose-600 text-white border-none col-span-2 md:col-span-1"><div className="flex items-start justify-between"><div><div className="opacity-80 text-xs font-medium mb-1">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏ß‡∏°</div><div className="text-2xl font-bold">‡∏ø{stats.totalRevenue.toLocaleString()}</div></div><DollarSign size={24} className="opacity-50" /></div></Card>
                                   <Card className="col-span-1"><div className="text-gray-500 text-xs font-medium mb-1">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ä‡∏¥‡πâ‡∏ô</div><div className="text-2xl font-bold text-gray-800">{stats.totalItems}</div></Card>
                                   <Card className="col-span-1"><div className="text-gray-500 text-xs font-medium mb-1">‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</div><div className="text-2xl font-bold text-gray-800">{stats.totalOrders}</div></Card>
                               </div>
                               <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                   <div className="bg-white rounded-2xl p-4 shadow-sm border border-gray-200"><h4 className="text-sm font-bold text-gray-500 mb-2 flex items-center gap-2"><TrendingUp size={16} className="text-pink-500" /> ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡πÅ‡∏ö‡∏£‡∏ô‡∏î‡πå</h4><div className="h-48"><ResponsiveContainer width="100%" height="100%"><BarChart data={stats.brandData} layout="vertical" margin={{left: 10, right: 10}}><CartesianGrid strokeDasharray="3 3" horizontal={true} vertical={false}/><XAxis type="number" hide /><YAxis dataKey="name" type="category" width={80} tick={{fontSize: 10}} /><Tooltip cursor={{fill: '#fce7f3'}} /><Bar dataKey="value" fill="#ec4899" radius={[0, 4, 4, 0]} barSize={20} /></BarChart></ResponsiveContainer></div></div>
                                   <div className="bg-white rounded-2xl p-4 shadow-sm border border-gray-200"><h4 className="text-sm font-bold text-gray-500 mb-2 flex items-center gap-2"><Palette size={16} className="text-blue-500" /> 10 ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏™‡∏µ‡∏Ç‡∏≤‡∏¢‡∏î‡∏µ</h4><div className="h-48"><ResponsiveContainer width="100%" height="100%"><BarChart data={stats.colorData}><CartesianGrid strokeDasharray="3 3" vertical={false}/><XAxis dataKey="name" tick={{fontSize: 10}} interval={0} /><Tooltip cursor={{fill: '#fce7f3'}} /><Bar dataKey="value" fill="#8b5cf6" radius={[4, 4, 0, 0]} barSize={30} /></BarChart></ResponsiveContainer></div></div>
                               </div>
                               <div className="space-y-4">
                                   <div className="flex justify-between items-center"><h3 className="font-bold text-gray-700 text-lg flex items-center gap-2"><List size={20} className="text-pink-500" /> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h3><button onClick={handleExportCSV} className="flex items-center gap-1 bg-green-500 text-white px-3 py-1.5 rounded-lg text-xs font-bold hover:bg-green-600 transition-colors shadow-sm"><FileSpreadsheet size={16} /> Export CSV</button></div>
                                   <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                        {orders.map(order => (
                                            <div key={order.id} className="bg-white p-5 rounded-2xl shadow-sm border border-gray-200 hover:shadow-md transition-all group flex flex-col justify-between min-h-[160px]">
                                                <div>
                                                    <div className="flex justify-between items-start mb-2"><div className="font-bold text-gray-800 text-lg line-clamp-1" title={order.shopName}>{order.shopName}</div><span className="bg-green-100 text-green-700 px-2 py-1 rounded-lg text-xs font-bold whitespace-nowrap">‡∏ø{(order.totalAmount || 0).toLocaleString()}</span></div>
                                                    <div className="text-sm text-gray-400 mb-3 flex items-center gap-1"><Calendar size={12} /> {order.orderDate}<span className="mx-1">‚Ä¢</span>{order.totalQuantity} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>
                                                    <div className="flex flex-wrap gap-1 mb-4">{order.items.slice(0, 3).map((i, idx) => (<span key={idx} className="bg-gray-50 px-2 py-1 rounded text-[10px] text-gray-600 border border-gray-100 font-medium">{i.brand}</span>))}{order.items.length > 3 && (<span className="text-[10px] text-gray-400 px-1 py-1">+{order.items.length - 3}</span>)}</div>
                                                    {order.note && <div className="mb-4 bg-gray-50 p-2 rounded text-xs text-gray-600 border border-gray-100 flex gap-2 items-start"><MessageSquare size={12} className="mt-0.5 text-pink-400 flex-shrink-0" /><span className="line-clamp-2">{order.note}</span></div>}
                                                </div>
                                                <div className="flex justify-end gap-2 border-t border-gray-50 pt-3 opacity-100 md:opacity-0 group-hover:opacity-100 transition-opacity">
                                                    <button onClick={() => handleFullPrint(order)} className="flex items-center gap-1 text-xs font-medium text-gray-500 hover:text-blue-600 hover:bg-blue-50 px-3 py-2 rounded-lg transition-colors" title="‡∏û‡∏¥‡∏°‡∏û‡πå PDF"><Printer size={16} /></button>
                                                    <button onClick={() => handleSaveImage(order)} className="flex items-center gap-1 text-xs font-medium text-gray-500 hover:text-green-600 hover:bg-green-50 px-3 py-2 rounded-lg transition-colors" title="‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û (PNG)"><ImageIcon size={16} /></button>
                                                    <button onClick={() => handleDeleteOrder(order.id)} className="flex items-center gap-1 text-xs font-medium text-gray-400 hover:text-red-600 hover:bg-red-50 px-3 py-2 rounded-lg transition-colors" title="‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£"><Trash2 size={16} /></button>
                                                </div>
                                            </div>
                                        ))}
                                   </div>
                                   {orders.length === 0 && <div className="text-center py-20 bg-white rounded-2xl border-2 border-dashed border-gray-200"><div className="w-16 h-16 bg-gray-50 rounded-full flex items-center justify-center mx-auto mb-4"><List size={32} className="text-gray-300" /></div><h3 className="text-gray-500 font-medium">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</h3><p className="text-gray-400 text-sm mt-1">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÅ‡∏£‡∏Å‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢</p></div>}
                               </div>
                           </div>
                        )}

                        {activeTab === 'report' && <ReportView />}
                        {activeTab === 'catalogue' && <CatalogueView />}
                        {activeTab === 'docs' && <DocumentView />}
                        </ErrorBoundary>
                    </main>

                    <BottomNav activeTab={activeTab} setActiveTab={setActiveTab} />
                    {toast && <Toast message={toast} />}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>


